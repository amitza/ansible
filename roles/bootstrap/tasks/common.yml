---
- name: Check for lock file
  stat:
    path: "/home/{{ user.name }}/.bootstrap.lock"
  register: bootsrtap_lock

- name: Install various utilities on Ubuntu
  become: true
  block:
    - name: Bootstraping the system
      debug:
        msg: "No lock file found. Bootstrapping the system."

    - name: Check if the OS is Ubuntu
      fail:
        msg: "This playbook only supports Ubuntu."
      when: ansible_facts['distribution'] != 'Ubuntu' # fail if not ubuntu

    - name: Update APT package cache
      apt:
        update_cache: true
        cache_valid_time: 3600 #  Cache is considered valid for 1 hour

    - name: Install required packages
      apt:
        name:
          - unzip
          - logrotate
          - git
          - jq
          - sed
          - wget
          - curl
          - coreutils
          - systemd
          - lz4
          - build-essential
          - unattended-upgrades
          - htop
          - iotop
          - net-tools
        state: present

    - name: Seting the hostname
      hostname:
        name: "{{ hostname }}"


    - name: Create lock file when this role is executed
      file:
        path: "/home/{{ user.name }}/.bootstrap.lock"
        state: touch
  when: not bootsrtap_lock.stat.exists

- name: Bootstraping the system is being skipped
  debug:
    msg: "Lock file found. Skipping bootsrap."
  when: bootsrtap_lock.stat.exists
